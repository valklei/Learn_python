Отчет по работе над учебным проектом

Дата выполнения задания: 07 января 2025 года

Дата составления отчета:  08 января 2025 года
Составил:                   Клейнберг Валерий

Описание концепции:
Linux-сервер по неизвестной причине перестал работать.
Веб-разработчик получил задачу на восстановление работоспособности сервера.

Описание инциндента:
Веб-сайт MediaWiki перестал работать.
При попытке доступа выводилось сообщение об ошибке "$wgServer must be set in LocalSettings.php", что указывало на проблему с конфигурацией сервера.    В процессе диагностики было также обнаружено отсутствие свободного дискового пространства.

Причина инцидента:
Основной причиной инцидента стало переполнение логов веб-сервера Apache,
а также некорректная конфигурация в файле LocalSettings.php.


Предпринятые шаги для восстановления сервиса и устранения проблемы
и полученные результаты::

1.	Подключение к серверу

Было принято решение подключиться к серверу для дальнейшего анализа.
для подключения к удаленному серверу с помощью SSH (Secure Shell)
с использованием приватного ключа для аутентификации использовали команду:

ssh -i /home/igor/ich/ich.pem ec2-user@3.79.39.74

Попытка оказалась неудачной.
Было получено сообщение, что права доступа к файлу /home/igor/ich/ich.pem
слишком открытые, а именно владелец файла имеет права на чтение и запись,
группа имеет права на чтение, а другие пользователи также имеют права на чтение. Для обеспечения безопасности приватные ключи SSH должны быть защищены от доступа других пользователей.
Права доступа были изменены командой:

chmod 600 /home/igor/ich/ich.pem

После чего повторно выполнена команда:

 ssh -i /home/igor/ich/ich.pem ec2-user@3.79.39.74

2.	Для проверки состояния службы Apache HTTP Server (httpd) была запущена команда:

 sudo systemctl status httpd

В результате выполнения данной команды получена информация о конфигурации службы, текущем статусе, процессах и логах, служба Apache HTTP Server (httpd) активна и работает уже 22 часа.

3.	Поиск и анализ файла LocalSettings.php

При помощи команды ls в домашней директории был обнаружен некий файл LocalSettings (5).php.
Далее был осуществлен поиск оригинального файла LocalSettings (5).php при помощи команды

 sudo find / -type f -name "LocalSettings.php

Файл был обнаружен по адресу  /var/www/html/mediawiki/LocalSettings.php

При просмотре содержимого файл оказался пустым.
Поэтому было принято решение посмотреть содержимое ранее обнаруженного
в домашней директории файла LocalSettings (5).php, предположив,
что это какой-то бэкап искомого файла.

4.	Обнаружение нехватки дискового пространства

При попытке просмотра содержимого файла  LocalSettings (5).php
было получено следующее сообщение:

cat L-bash: cannot create temp file for here-document: No space left on device

то есть отсутствие свободного дискового пространства.
Выполнив команду df -h, этому было получено подтверждение.

5.	Поиск больших файлов:

Для поиска файлов, занимающих наибольшее место, была использована команда:

sudo find / -type f -size +1G

Это позволило обнаружить файл /var/log/httpd/access_log и с помощью команды

         sudo du -h /var/log/httpd/access_log

установить его размер, который составлял 7G.

6.	Очистка дискового пространства

Далее было принято решение очистить файл с помощью команды

sudo truncate -s 0 /var/log/httpd/access_log

Эта команда помечает область с данными как свободную и является быстрой.

После этого оказался возможен просмотр файла LocalSettings (5).php.

7.	Исправление файла конфигурации

Так как было установлено, что файл LocalSettings.php
в директории /var/www/html/mediawiki пуст,
а в домашней директории файл LocalSettings (5).php содержал конфигурации,
пустой файл в /var/www/html/mediawiki был заменен файлом с конфигурациями
с помощью команды

      cp LocalSettings (5).php  /var/www/html/mediawiki/ LocalSettings.php

При просмотре в файле конфигурации LocalSettings.php обнаружено
некорректное значение переменной $wgServer.
В файле конфигурации LocalSettings.php были внесены
изменения (с помощью редактора vim), а именно "$wgServer = "https://3.79.39.74";".

8.	Проверка состояния Apache и его перезапуск:

После внесения изменений была проверена работа веб-сервера Apache.
Затем сервер Apache был перезапущен для применения изменений.

9.	Создание скрипта для архивирования и очистки логов

Был написан скрипт log_backup.sh, который архивирует логи, очищает их и удаляет архивы старше одного дня.
С помощью команды
                Sudo crontab -l
было установлено, что выполняется команда, которая каждую минуту создает архив “сам на себя”.

Редактирование было осуществлено командой

                  Sudo crontab -e

Старую команду отключили комментариями и добавили для выполнения команду:

0 0 * * * /home/ec2-user/log_backup.sh

Далее дали скрипту права на выполнение:

     chmod +x log_backup.sh


                                              ВЫВОДЫ

Причина инцидента:

Основной причиной инцидента стало переполнение логов веб-сервера Apache, а также некорректная конфигурация в файле LocalSettings.php.

Результаты:

Веб-сайт MediaWiki был успешно восстановлен, сервер Apache перезапущен, и доступ к сайту был возобновлен.
Проблема с отсутствием свободного дискового пространства была решена благодаря очистке логов и отключению частого выполнения некорректной задачи архивации.
Конфигурация переменной $wgServer в файле LocalSettings.php была исправлена, что позволило устранить проблему с доступом к сайту.
Рекомендации:

Мониторинг дискового пространства:

Настроить систему мониторинга дискового пространства с оповещениями о его заполнении для предотвращения повторения подобных ситуаций.
Регулярная проверка задач crontab:

Периодически проверять задания в crontab для предотвращения слишком частого выполнения задач, которые могут привести к перегрузке системы.
Заключение:

Инцидент был успешно устранен. Веб-сайт MediaWiki восстановлен, веб-сервер Apache работает корректно, а дополнительные меры по предотвращению подобных ситуаций были внедрены.
